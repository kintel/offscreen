name: Cut Release and Create Source Tarball

on:
  push:
    tags:
      - 'offscreen-*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6
      with:
        submodules: 'true'

    - name: Extract version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/offscreen-}" >> $GITHUB_ENV

    - name: Create VERSION file
      run: echo ${{ env.VERSION }} > VERSION.txt

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.x'

    - name: Install git-archive-all
      run: pip install git-archive-all

    - name: Create source tarball
      run: |
        git-archive-all --force-submodules --prefix=offscreen-${{ env.VERSION }}/ offscreen-${{ env.VERSION }}.tar
        tar -rf offscreen-${{ env.VERSION }}.tar --transform "s|^|offscreen-${{ env.VERSION }}/|" VERSION.txt
        gzip offscreen-${{ env.VERSION }}.tar

    - name: Upload artifact
      uses: actions/upload-artifact@v6
      with:
        name: offscreen-${{ env.VERSION }}.tar.gz
        path: offscreen-${{ env.VERSION }}.tar.gz
